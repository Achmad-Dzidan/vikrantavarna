<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Linimasa & Tim Proyek</title>
    <link rel="icon" type="image/x-icon" href="/src/logo.jpg">
    <link rel="stylesheet" href="style/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>

    <div class="main-wrapper">
        <div class="card-backdrop"></div>
        
        <div class="content-stack">
            <div class="card headd-container">
                <p>Linimasa Kuliah Kerja Nyata</p>
                <p>VIKRANTAVARNA</p>
                <p><span class="headd">Universitas Islam Negeri Syarif Hidayatullah Jakarta</span></p>
                <p><span class="headd" style="font-size: 10px;">Made with <i class="fas fa-heart" style="color: #e74c3c;"></i> by Achmad Dzidan</span></p>
            </div>
            
            <div class="card timeline-container">
                <h2>Linimasa Proyek Terperinci</h2>
                <ul class="timeline" id="timelineList">
                </ul>
                <div class="timeline-item-actions">
                    <button class="btn-add" onclick="openAddModal()">Tambah</button>
                </div>
            </div>

            <div class="card overview-container">
                <h2>Gambaran Umum Proyek</h2>
                <p>Visualisasi ini menunjukkan distribusi total tugas di antara semua divisi selama periode KKN. Gunakan bagan ini untuk mendapatkan pemahaman cepat tentang beban kerja setiap divisi.</p>
                <div class="chart-wrapper">
                    <canvas id="myDoughnutChart"></canvas>
                </div>
            </div>
            
            <div class="card progress-container">
                <h2>Kemajuan Hari Ini</h2>
                <p>Ini adalah total kemajuan dari semua tugas yang tercatat untuk tanggal yang sedang Anda lihat. Lacak progres harian Anda dengan cepat.</p>
                <div class="progress-section">
                    <label class="progress-label">Total Kemajuan Hari Ini</label>
                    <div class="progress-bar-wrapper">
                        <div class="progress-bar-background">
                            <div id="progressBarFill" class="progress-bar-fill"></div>
                        </div>
                        <span id="progressPercentage" class="progress-percentage">0%</span>
                    </div>
                </div>
            </div>

            <div class="card task-progress-card">
                <h2>Kemajuan Progress</h2>
                <p>Pilih bulan dan tanggal untuk melihat tugas yang diuraikan per divisi.</p>
                <div class="tabs-nav">
                    <button class="tab-link" data-tab="juni">Juni</button>
                    <button class="tab-link" data-tab="juli">Juli</button>
                </div>
                <div class="tabs-content">
                    <div id="juni" class="tab-pane">
                        <div class="sub-tabs-nav">
                           </div>
                        <div class="division-cards-container">
                            </div>
                    </div>
                    <div id="juli" class="tab-pane">
                        <div class="sub-tabs-nav">
                             </div>
                        <div class="division-cards-container">
                           </div>
                    </div>
                </div>
            </div>

            <div id="divisionTaskModal" class="modal-overlay">
                <div class="modal-content">
                    <form id="divisionTaskForm" class="modal-form">
                        <h3 id="divisionTaskModalTitle">Tambah Tugas Baru</h3>
                        <input type="hidden" id="divisionIdField">
                        <div>
                            <label for="taskDescription">Deskripsi Tugas</label>
                            <input type="text" id="taskDescription" placeholder="Contoh: Memantau progress divisi" required>
                        </div>
                        
                        <div class="time-input-container">
                            <div class="time-input-wrapper">
                                <label for="taskStartTime">Waktu Mulai</label>
                                <input type="time" id="taskStartTime">
                            </div>
                            <span class="time-separator">-</span>
                            <div class="time-input-wrapper">
                                <label for="taskEndTime">Waktu Berakhir</label>
                                <input type="time" id="taskEndTime">
                            </div>
                        </div>

                        <div class="modal-actions">
                            <button type="button" class="btn-secondary" id="cancelDivisionTaskBtn">Batal</button>
                            <button type="button" class="btn-primary" id="saveOnlyBtn">Simpan</button>
                            <button type="button" class="btn-primary" id="saveAndShareBtn">
                                <i class="fab fa-whatsapp"></i> Simpan & Bagikan
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="card headd-container end">
                <p><span class="headd">Made with <i class="fas fa-heart" style="color: #e74c3c;"></i> by Achmad Dzidan</span></p>
            </div>
        </div>
    </div>

    <div id="timelineModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle">Tambah Item Linimasa</h3>
            <input type="text" id="modalId" hidden>
            <input type="date" id="modalDate" required>
            <input type="text" id="modalTitleInput" placeholder="Judul" required>
            <textarea id="modalDesc" placeholder="Deskripsi" required></textarea>
            <button class="btn-save" onclick="saveTimelineItem()">Simpan</button>
            <button class="btn-cancel" onclick="closeModal()">Batal</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, doc, collection, setDoc, onSnapshot, addDoc, serverTimestamp, query, updateDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBW_s50tO6zvNl-Jvkm6iQcbRMLebeLRgw",
            authDomain: "vikrantavarna-ee40e.firebaseapp.com",
            projectId: "vikrantavarna-ee40e",
            storageBucket: "vikrantavarna-ee40e.appspot.com",
            messagingSenderId: "880669712876",
            appId: "1:880669712876:web:7c873784fde86d4679a0c9",
            measurementId: "G-SD61TKCVQ3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const timelineCollectionRef = collection(db, "timeline");
        const divisionTasksRef = collection(db, "divisionTasks");

        // ==========================================================
        // --- BLOK UTAMA: DOMContentLoaded ---
        // ==========================================================
        
    document.addEventListener('DOMContentLoaded', () => {
        let myDoughnutChart;
        const divisionTaskModal = document.getElementById('divisionTaskModal');
        const divisionTaskForm = document.getElementById('divisionTaskForm');
        const ctx = document.getElementById('myDoughnutChart');

        // Struktur kartu divisi untuk dirender
        const divisionCardHTML = (divisionId, divisionName) => `
            <div class="nested-card" data-division-id="${divisionId}">
                <h3>${divisionName}</h3>
                <div class="progress-section"><label class="progress-label">Kemajuan</label><div class="progress-bar-wrapper"><div class="progress-bar-background"><div class="progress-bar-fill"></div></div><span class="progress-percentage">0%</span></div></div>
                <div class="task-list"></div>
                <button class="add-task-btn" data-division="${divisionId}"><i class="fas fa-plus"></i> Tambah Tugas</button>
            </div>`;

        const divisions = [
            { id: 'ketua-wakil', name: 'Ketua dan Wakil' }, { id: 'sekertaris', name: 'Sekertaris' },
            { id: 'bendahara', name: 'Bendahara' }, { id: 'acara', name: 'Acara' },
            { id: 'logistik', name: 'Logistik' }, { id: 'humas', name: 'Humas' },
            { id: 'konsumsi', name: 'Konsumsi' }, { id: 'pdd', name: 'PDD' }
        ];

        // Inisialisasi kartu divisi di kedua tab
        const juniCardsContainer = document.querySelector('#juni .division-cards-container');
        const juliCardsContainer = document.querySelector('#juli .division-cards-container');
        
        let allCardsHTML = '';
        divisions.forEach(div => allCardsHTML += divisionCardHTML(div.id, div.name));
        juniCardsContainer.innerHTML = allCardsHTML;
        juliCardsContainer.innerHTML = allCardsHTML;


        if (ctx) {
            const chartConfig = {
                type: 'doughnut',
                data: {
                    labels: divisions.map(d => d.name),
                    datasets: [{
                        label: 'Jumlah Tugas',
                        data: Array(divisions.length).fill(0),
                        backgroundColor: ['#3498db', '#9b59b6', '#e67e22', '#e74c3c', '#f1c40f', '#1abc9c', '#2ecc71', '#7f8c8d'],
                        borderColor: '#f0f2f5', borderWidth: 4, hoverOffset: 8
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, cutout: '60%',
                    plugins: {
                        legend: { position: 'bottom', labels: { padding: 20, boxWidth: 12, font: { family: "'Roboto', sans-serif" }}},
                        tooltip: { callbacks: { label: (c) => `${c.label}: ${c.parsed} Tugas` }}
                    }
                }
            };
            myDoughnutChart = new Chart(ctx, chartConfig);
        }
        
        const today = new Date();
        // Untuk pengujian, Anda bisa mengganti `today` dengan tanggal lain
        // const today = new Date('2025-07-03T10:00:00'); 
        let activeDate = today.getDate();
        let activeMonth = today.getMonth() + 1; // 1-12
        let activeDateRange = '';
        let allTasksCache = [];

        const dateRanges = {
            juni: [{label: '1 - 7', start: 1, end: 7}, {label: '8 - 14', start: 8, end: 14}, {label: '15 - 21', start: 15, end: 21}, {label: '22 - 30', start: 22, end: 30}],
            juli: [{label: '1 - 7', start: 1, end: 7}, {label: '8 - 14', start: 8, end: 14}, {label: '15 - 21', start: 15, end: 21}, {label: '22 - 31', start: 22, end: 31}]
        };

        // Fungsi untuk membuat tombol sub-tab
        const createSubTabButtons = (monthName) => {
            const navContainer = document.querySelector(`#${monthName} .sub-tabs-nav`);
            navContainer.innerHTML = '';
            dateRanges[monthName].forEach(range => {
                const button = document.createElement('button');
                button.className = 'sub-tab-link';
                button.dataset.range = range.label;
                button.dataset.start = range.start;
                button.dataset.end = range.end;
                button.textContent = range.label;
                navContainer.appendChild(button);
            });
        };

        createSubTabButtons('juni');
        createSubTabButtons('juli');
        
        const activateCurrentDateTabs = () => {
            const monthName = activeMonth === 6 ? 'juni' : 'juli';
            
            document.querySelectorAll('.tab-link').forEach(tab => tab.classList.toggle('active', tab.dataset.tab === monthName));
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.toggle('active', pane.id === monthName));

            const activeMonthPane = document.querySelector('.tab-pane.active');
            if (activeMonthPane) {
                let activeRangeTab;
                activeMonthPane.querySelectorAll('.sub-tab-link').forEach(tab => {
                    const start = parseInt(tab.dataset.start, 10);
                    const end = parseInt(tab.dataset.end, 10);
                    const isActive = activeDate >= start && activeDate <= end;
                    tab.classList.toggle('active', isActive);
                    if (isActive) {
                        activeRangeTab = tab;
                        activeDateRange = tab.dataset.range;
                    }
                });
                if (activeRangeTab) {
                    activeRangeTab.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                }
            }
        };
        
        const showDivisionTaskModal = (show = true) => divisionTaskModal.classList.toggle('visible', show);
        
        const updateProgressBar = (container) => {
            const allCheckboxes = container.querySelectorAll('.task-checkbox');
            const checkedCheckboxes = container.querySelectorAll('.task-checkbox:checked');
            const percentage = allCheckboxes.length > 0 ? (checkedCheckboxes.length / allCheckboxes.length) * 100 : 0;
            const bar = container.querySelector('.progress-bar-fill');
            const text = container.querySelector('.progress-percentage');
            if (bar) bar.style.width = `${percentage}%`;
            if (text) text.textContent = `${Math.round(percentage)}%`;
        };

        const updateTotalProgress = () => {
            const activeCardsContainer = document.querySelector('.tab-pane.active .division-cards-container');
            if (!activeCardsContainer) return;
            const allTasksForRange = activeCardsContainer.querySelectorAll('.task-checkbox');
            const checkedTasksForRange = activeCardsContainer.querySelectorAll('.task-checkbox:checked');
            const totalPercentage = allTasksForRange.length > 0 ? (checkedTasksForRange.length / allTasksForRange.length) * 100 : 0;
            
            const bar = document.getElementById('progressBarFill');
            const text = document.getElementById('progressPercentage');
            if (bar) bar.style.width = `${totalPercentage}%`;
            if (text) text.textContent = `${Math.round(totalPercentage)}%`;
        };

        const updateDoughnutChart = () => {
            if (!myDoughnutChart) return;

            const activeRangeButton = document.querySelector('.sub-tab-link.active');
            if (!activeRangeButton) return;
            const start = parseInt(activeRangeButton.dataset.start);
            const end = parseInt(activeRangeButton.dataset.end);

            const tasksForRange = allTasksCache.filter(task => {
                 const taskDate = new Date(task.taskDate + 'T00:00:00');
                 const date = taskDate.getDate();
                 const month = taskDate.getMonth() + 1;
                 return month === activeMonth && date >= start && date <= end;
            });

            const taskCounts = divisions.reduce((acc, div) => {
                acc[div.id] = tasksForRange.filter(t => t.divisionId === div.id).length;
                return acc;
            }, {});
            
            myDoughnutChart.data.datasets[0].data = divisions.map(div => taskCounts[div.id] || 0);
            myDoughnutChart.update();
        };

        const loadTimelineItems = () => onSnapshot(timelineCollectionRef, (snapshot) => {
            const list = document.getElementById('timelineList');
            if(!list) return;
            const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            items.sort((a, b) => new Date(a.date) - new Date(b.date));
            list.innerHTML = items.map(item => `
                <li class="timeline-item" data-id="${item.id}">
                    <div class="item-date">${new Date(item.date + 'T00:00:00').toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'})}</div>
                    <h3 class="item-title">${item.title}</h3>
                    <p class="item-desc">${item.description.replace(/\n/g, '<br>')}</p>
                </li>`
            ).join('');
        });

        const renderAllDivisionTasks = () => {
            const activePane = document.querySelector('.tab-pane.active');
            if (!activePane) return;
            const activeRangeButton = activePane.querySelector('.sub-tab-link.active');
            if (!activeRangeButton) return;

            const start = parseInt(activeRangeButton.dataset.start);
            const end = parseInt(activeRangeButton.dataset.end);

            const tasksForRange = allTasksCache.filter(task => {
                 const taskDate = new Date(task.taskDate + 'T00:00:00');
                 const date = taskDate.getDate();
                 const month = taskDate.getMonth() + 1;
                 return month === activeMonth && date >= start && date <= end;
            });

            const tasksByDivision = tasksForRange.reduce((acc, task) => {
                (acc[task.divisionId] = acc[task.divisionId] || []).push(task);
                return acc;
            }, {});

            activePane.querySelectorAll('.nested-card[data-division-id]').forEach(card => {
                const divisionId = card.dataset.divisionId;
                const tasksForDivision = tasksByDivision[divisionId] || [];
                const taskList = card.querySelector('.task-list');
                
                if (tasksForDivision.length === 0) {
                    taskList.innerHTML = `<p class="no-task-msg">Tidak ada tugas untuk rentang tanggal ini.</p>`;
                } else {
                    tasksForDivision.sort((a, b) => a.taskDate.localeCompare(b.taskDate) || (a.startTime || "00:00").localeCompare(b.startTime || "00:00"));
                    taskList.innerHTML = tasksForDivision.map(task => {
                         const taskDay = new Date(task.taskDate + 'T00:00:00').toLocaleDateString('id-ID', { weekday: 'long' });
                         return `
                            <div class="checkbox-item">
                                <input type="checkbox" id="${task.id}" class="task-checkbox" data-doc-id="${task.id}" ${task.isCompleted ? 'checked' : ''}>
                                <label for="${task.id}">
                                    <span>${task.description}</span>
                                    <span class="task-time">(${taskDay}) ${task.startTime || ''} - ${task.endTime || ''}</span>
                                </label>
                            </div>`;
                    }).join('');
                }
                updateProgressBar(card);
            });
            updateTotalProgress();
            updateDoughnutChart();
        };

        const showToast = (message, type = 'success') => {
             const toast = document.createElement('div');
             toast.className = `toast ${type} show`;
             toast.textContent = message;
             document.body.appendChild(toast);
             setTimeout(() => {
                 toast.classList.remove('show');
                 setTimeout(() => toast.remove(), 500);
             }, 3000);
        };

        window.openAddModal = () => document.getElementById('timelineModal').style.display = 'block';
        window.closeModal = () => document.getElementById('timelineModal').style.display = 'none';
        window.onclick = (event) => { if (event.target == document.getElementById('timelineModal')) closeModal(); };

        window.saveTimelineItem = async () => {
            const data = {
                date: document.getElementById('modalDate').value,
                title: document.getElementById('modalTitleInput').value,
                description: document.getElementById('modalDesc').value,
                createdAt: serverTimestamp()
            };
            if (!data.date || !data.title || !data.description) return alert("Semua bidang harus diisi.");
            try {
                await addDoc(timelineCollectionRef, data);
                alert("Item berhasil disimpan!");
                closeModal();
            } catch (error) {
                console.error("Gagal menyimpan linimasa:", error);
                alert("Terjadi kesalahan saat menyimpan.");
            }
        };

        const handleSaveTask = async (shouldShare = false) => {
            const description = document.getElementById('taskDescription').value;
            const divisionId = document.getElementById('divisionIdField').value;
            if (!description) return showToast("Deskripsi tugas tidak boleh kosong.", 'error');

            // Untuk menambahkan tugas baru, secara default kita tambahkan di tanggal hari ini
            const selectedDateString = today.toISOString().split('T')[0]; // Format YYYY-MM-DD

            const data = {
                divisionId,
                description,
                taskDate: selectedDateString,
                startTime: document.getElementById('taskStartTime').value || "",
                endTime: document.getElementById('taskEndTime').value || "",
                isCompleted: false,
                createdAt: serverTimestamp(),
            };
            
            try {
                await addDoc(divisionTasksRef, data);
                showDivisionTaskModal(false);
                showToast(`Tugas untuk ${divisionId} berhasil disimpan!`);

                if (shouldShare) {
                    const pesan = `ðŸ”” *Notifikasi Tugas Baru* ðŸ””\n\nHalo tim! Ada tugas baru untuk divisi *${divisionId.replace('-', ' ')}*:\n\nðŸ“ *Tugas*: ${data.description}\nðŸ“† *Hari*: ${today.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long' })}\nâ° *Waktu*: ${data.startTime || 'N/A'} - ${data.endTime || 'N/A'}\n\nMohon perhatiannya. Terima kasih dan semangat! âœ¨`;
                    if (navigator.share) {
                        await navigator.share({ title: 'Notifikasi Tugas Baru KKN', text: pesan });
                    } else {
                        navigator.clipboard.writeText(pesan);
                        showToast("Pesan disalin! Silakan tempel di grup WhatsApp.");
                    }
                }
            } catch (error) {
                showToast("Gagal menyimpan tugas.", 'error');
                console.error("Error saving task: ", error);
            }
        };
        
        document.getElementById('saveOnlyBtn').addEventListener('click', () => handleSaveTask(false));
        document.getElementById('saveAndShareBtn').addEventListener('click', () => handleSaveTask(true));
        document.getElementById('cancelDivisionTaskBtn').addEventListener('click', () => showDivisionTaskModal(false));

        // Event Delegation untuk seluruh konten
        document.querySelector('.tabs-content').addEventListener('click', (e) => {
            // Tombol tambah tugas
            const addTaskBtn = e.target.closest('.add-task-btn');
            if (addTaskBtn) {
                const divisionId = addTaskBtn.dataset.division;
                divisionTaskForm.reset();
                document.getElementById('divisionIdField').value = divisionId;
                document.getElementById('divisionTaskModalTitle').textContent = `Tambah Tugas untuk ${divisions.find(d=>d.id === divisionId).name}`;
                showDivisionTaskModal();
            }

            // Tombol sub-tab rentang tanggal
            const subTabLink = e.target.closest('.sub-tab-link');
            if (subTabLink) {
                const parentNav = subTabLink.parentElement;
                parentNav.querySelector('.active')?.classList.remove('active');
                subTabLink.classList.add('active');
                activeDateRange = subTabLink.dataset.range;
                renderAllDivisionTasks();
            }
        });
        
        document.querySelector('.tabs-content').addEventListener('change', async (e) => {
             // Checkbox tugas
             if (e.target.classList.contains('task-checkbox')) {
                const docId = e.target.dataset.docId;
                const isCompleted = e.target.checked;
                try {
                    await updateDoc(doc(db, "divisionTasks", docId), { isCompleted });
                    // UI akan diperbarui oleh snapshot listener
                } catch(error) {
                    console.error("Error updating task status:", error);
                    showToast("Gagal memperbarui status tugas.", "error");
                }
             }
        });

        // Event listener untuk tab bulan utama
        document.querySelectorAll('.tab-link').forEach(link => {
            link.addEventListener('click', (e) => {
                const tabId = e.currentTarget.dataset.tab;
                activeMonth = tabId === 'juni' ? 6 : 7;
                
                // Jika pindah bulan, pilih rentang tanggal pertama secara default
                const isTodayInThisMonth = activeMonth === (today.getMonth() + 1);
                if (isTodayInThisMonth) {
                    activeDate = today.getDate();
                } else {
                    activeDate = 1; // Jika bukan bulan ini, aktifkan tanggal 1
                }
                
                activateCurrentDateTabs();
                renderAllDivisionTasks();
            });
        });

        // Inisialisasi awal
        onSnapshot(query(divisionTasksRef), (snapshot) => {
            allTasksCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            activateCurrentDateTabs(); // Aktifkan tab berdasarkan tanggal hari ini
            renderAllDivisionTasks();  // Render konten berdasarkan tab yang aktif
            loadTimelineItems();
        });
    });
    </script>
</body>
</html>